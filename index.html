<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ERçŠ¶æ³å…±æœ‰ã‚·ã‚¹ãƒ†ãƒ </title>
<style>
    /* --- DESIGN SYSTEM --- */
    :root {
        --bg-staff: #2d3436;
        --bg-patient: #f5f6fa;
        --c-blue: #0984e3; --c-red: #d63031; --c-purple: #6c5ce7;
        --c-orange: #e17055; --c-yellow: #fdcb6e; --c-green: #00b894;
        --c-grey: #636e72; --c-teal: #00cec9;
        --c-ward: #8e44ad; /* ç—…æ£Ÿç§»å‹•ç”¨ã‚«ãƒ©ãƒ¼ */
    }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Yu Gothic", sans-serif; }
    body { height: 100vh; overflow: hidden; margin: 0; }
    
    /* View Switcher */
    #staff-app, #patient-app { display: none; height: 100%; width: 100%; }
    body.mode-staff #staff-app { display: flex; }
    body.mode-patient #patient-app { display: flex; }

    /* === STAFF UI STYLES === */
    #staff-app { background: var(--bg-staff); color: white; flex-direction: column; }
    .staff-header { padding: 15px; background: #000; border-bottom: 1px solid #555; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
    .staff-body { flex: 1; display: flex; overflow: hidden; }
    
    /* Sidebar Grid */
    .card-list { width: 280px; background: #222; padding: 10px; overflow-y: auto; border-right: 1px solid #555; display: grid; grid-template-columns: repeat(4, 1fr); grid-auto-rows: 55px; gap: 6px; flex-shrink: 0; }
    .s-card { background: #444; border: 2px solid #555; border-radius: 5px; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; color: #aaa; font-size: 1.1rem; user-select: none; position: relative; transition: all 0.2s; }
    .s-card:hover { filter: brightness(1.2); }
    .s-card.active { border-color: white; box-shadow: 0 0 0 2px white inset; z-index: 10; }
    
    /* Dynamic Status Colors */
    .s-card.st-initial { border: 2px solid var(--c-green); color: white; background: #2d3436; }
    .s-card.st-initial::after { content: 'ONLINE'; position: absolute; bottom: 2px; font-size: 0.5rem; color: var(--c-green); }
    .s-card.st-exam_start, .s-card.st-analyzing { background: var(--c-blue); color: white; border: none; }
    .s-card.st-emergency { background: var(--c-red); color: white; border: none; animation: pulse 1s infinite; }
    .s-card.st-test_start, .s-card.st-test_add { background: var(--c-purple); color: white; border: none; }
    .s-card.st-image_wait { background: var(--c-orange); color: white; border: none; }
    .s-card.st-long_wait { background: var(--c-yellow); color: #333; border: none; }
    .s-card.st-explain_15, .s-card.st-er_wait { background: var(--c-green); color: white; border: none; }
    .s-card.st-ward { background: var(--c-ward); color: white; border: none; }
    .s-card.st-custom { background: var(--c-teal); color: #333; border: none; }
    .s-card.st-end { opacity: 0.4; }

    /* Controls Area (Default Mobile View) */
    .controls { flex: 1; padding: 20px; overflow-y: auto; background: #2d3436; display: flex; flex-direction: column; gap: 20px; }
    .controls-left-panel, .controls-right-panel { display: flex; flex-direction: column; gap: 20px; }

    /* â˜…â˜…â˜… iPad / Desktop Layout Optimization â˜…â˜…â˜… */
    @media (min-width: 768px) {
        .controls {
            display: grid;
            grid-template-columns: 380px 1fr; /* Left fixed width, Right takes rest */
            grid-template-rows: 1fr;
            gap: 30px;
            align-items: start;
            overflow-y: hidden; /* Hide main scrollbar */
        }
        .controls-right-panel {
            overflow-y: auto; /* Scroll only buttons if needed */
            max-height: 100%;
            padding-right: 5px;
        }
        /* Slight adjustment for preview area on wider screens */
        .preview-area { flex-direction: row; text-align: left; }
        .preview-info { margin-bottom: 0; margin-right: 20px; }
    }
    
    /* Live Preview Monitor */
    .preview-area { background: #1a1a1a; padding: 15px; border-radius: 12px; display: flex; flex-direction: column; align-items: center; border: 1px solid #444; text-align: center; }
    .preview-info { flex: 1; margin-bottom: 15px; }
    .preview-phone { width: 160px; height: 280px; background: white; border-radius: 16px; border: 5px solid #333; overflow: hidden; position: relative; display: flex; flex-direction: column; box-shadow: 0 4px 10px rgba(0,0,0,0.3); margin: 0 auto; }
    .preview-header { background: #2d3436; height: 25px; width: 100%; flex-shrink: 0; }
    .preview-body { flex: 1; padding: 8px; display: flex; flex-direction: column; align-items: center; text-align: center; color: #333; overflow: hidden; justify-content: center; }
    .prev-icon { font-size: 3rem; margin-bottom: 8px; display: block; line-height: 1; }
    .prev-title { font-size: 0.9rem; font-weight: 800; margin-bottom: 4px; line-height: 1.2; color: #2d3436; }
    .prev-msg { font-size: 0.65rem; color: #636e72; background: #f1f2f6; padding: 6px; border-radius: 6px; width: 100%; line-height: 1.4; }
    
    /* Preview Modes */
    .preview-body.mode-alert { background: #fff5f5; } .preview-body.mode-alert .prev-title { color: var(--c-red); }
    .preview-body.mode-custom { background: #e0f7fa; } .preview-body.mode-custom .prev-title { color: #006064; }
    .preview-body.mode-ward { background: #f3e5f5; } .preview-body.mode-ward .prev-title { color: var(--c-ward); }
    .preview-body.mode-end { background: #eee; } .preview-body.mode-end .prev-icon { opacity: 0.3; }

    /* Input & Buttons */
    .custom-input-area { background: #3a4244; padding: 15px; border-radius: 8px; border: 1px solid #555; }
    .custom-input-row { display: flex; gap: 10px; margin-top: 10px; }
    input[type="text"] { flex: 1; padding: 12px; border-radius: 6px; border: none; font-size: 1rem; outline: none; }
    .btn-send { background: var(--c-teal); color: #2d3436; font-weight: bold; cursor: pointer; padding: 0 20px; border: none; border-radius: 6px; transition: opacity 0.2s; white-space: nowrap; }
    .btn-send:hover { opacity: 0.8; }
    
    .btn-group { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-bottom: 20px; }
    .btn { padding: 12px; border: none; border-radius: 8px; color: white; font-weight: bold; font-size: 0.9rem; cursor: pointer; text-align: left; display: flex; align-items: center; transition: transform 0.1s, filter 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .btn:hover { filter: brightness(1.1); transform: translateY(-1px); }
    .btn:active { transform: scale(0.98); }
    .btn i { font-size: 1.3rem; margin-right: 10px; width: 25px; text-align: center; }
    
    .bg-blue { background: var(--c-blue); } .bg-red { background: var(--c-red); } .bg-purple { background: var(--c-purple); }
    .bg-orange { background: var(--c-orange); } .bg-yellow { background: var(--c-yellow); color: #333; } .bg-green { background: var(--c-green); } .bg-grey { background: var(--c-grey); }
    .bg-ward { background: var(--c-ward); }

    /* === PATIENT UI STYLES === */
    #patient-app { background: var(--bg-patient); flex-direction: column; align-items: center; justify-content: center; }
    .phone-container { width: 100%; max-width: 480px; height: 100%; background: white; display: flex; flex-direction: column; box-shadow: 0 0 30px rgba(0,0,0,0.1); }
    .p-header { background: #2d3436; color: white; padding: 18px; text-align: center; font-weight: bold; font-size: 1.1rem; }
    .p-body { flex: 1; padding: 30px; display: flex; flex-direction: column; align-items: center; text-align: center; overflow-y: auto; }
    .p-badge { background: #dfe6e9; padding: 6px 16px; border-radius: 20px; font-weight: bold; color: #636e72; margin-bottom: 30px; font-size: 0.9rem; }
    .p-icon { font-size: 7rem; margin: 20px 0 30px; display: block; line-height: 1; }
    .p-title { font-size: 2rem; font-weight: 800; color: #2d3436; margin-bottom: 20px; line-height: 1.3; }
    .p-msg { font-size: 1.1rem; color: #636e72; line-height: 1.8; background: #f1f2f6; padding: 20px; border-radius: 12px; width: 100%; word-break: break-all; }
    .p-time { font-size: 0.85rem; color: #b2bec3; margin-top: auto; width: 100%; text-align: right; padding-top: 20px; }
    
    /* Patient States */
    .mode-alert .p-body { background: #fff5f5; } .mode-alert .p-title { color: var(--c-red); }
    .mode-custom .p-body { background: #e0f7fa; } .mode-custom .p-title { color: #006064; }
    .mode-ward .p-body { background: #f3e5f5; } .mode-ward .p-title { color: var(--c-ward); }
    .mode-end .p-body { background: #eee; justify-content: center; } .mode-end .p-icon { opacity: 0.2; } .mode-end .p-title { color: #aaa; }
    
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
</style>
</head>
<body>

<div id="staff-app">
    <div class="staff-header">
        <h2>ğŸ¥ ER Status Console</h2>
        <div style="font-size:0.8rem; color:#aaa; display:flex; gap:10px; align-items:center;">
            <span id="auth-display">Auth: Checking...</span>
            <span id="sys-status">Server: Connecting...</span>
        </div>
    </div>
    <div class="staff-body">
        <div class="card-list" id="s-grid">
            <div style="padding:20px; color:#aaa;">Loading...</div>
        </div>
        
        <div class="controls" id="s-controls" style="opacity:0.3; pointer-events:none;">
            
            <div class="controls-left-panel">
                <div class="preview-area">
                    <div class="preview-info">
                        <div style="font-size:1.2rem; margin-bottom:10px; border-bottom:1px solid #555; padding-bottom:5px;">
                            å¯¾è±¡: <span id="s-target-num" style="color:var(--c-blue); font-weight:bold;">--</span>
                        </div>
                        <p style="font-size:0.8rem; color:#aaa; line-height:1.4;">
                            <span style="color:var(--c-green);">â—</span> æ‚£è€…ç”»é¢ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼<br>
                            (ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸä¸­)
                        </p>
                    </div>
                    <div class="preview-phone">
                        <div class="preview-header"></div>
                        <div class="preview-body" id="prev-screen">
                            <span class="prev-icon">ğŸ“·</span>
                            <div class="prev-title">æœªæ¥ç¶š</div>
                            <div class="prev-msg">QRèª­å–å¾…æ©Ÿä¸­</div>
                        </div>
                    </div>
                </div>

                <div class="custom-input-area">
                    <div style="font-size:0.85rem; color:#ccc; font-weight:bold;">ğŸ“© è‡ªç”±è¨˜è¿°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>
                    <div class="custom-input-row">
                        <input type="text" id="custom-msg-input" placeholder="ä¾‹: 1ç•ªè¨ºå¯Ÿå®¤ã®å‰ã¸">
                        <button class="btn-send" onclick="sendCustomMessage()">é€ä¿¡</button>
                    </div>
                </div>
            </div>
            
            <div class="controls-right-panel">
                <p style="color:#aaa; font-size:0.8rem; margin-bottom:8px; border-left:3px solid #555; padding-left:8px;">è¨ºå¯Ÿãƒ»å‡¦ç½®çŠ¶æ³</p>
                <div class="btn-group">
                    <button class="btn bg-blue" onclick="updateStatus('exam_start')"><i>ğŸ‘¨â€âš•ï¸</i>è¨ºå¯Ÿé–‹å§‹</button>
                    <button class="btn bg-red" onclick="updateStatus('emergency')"><i>ğŸš‘</i>ç·Šæ€¥å‡¦ç½®ä¸­</button>
                </div>
                
                <p style="color:#aaa; font-size:0.8rem; margin-bottom:8px; border-left:3px solid #555; padding-left:8px;">æ¤œæŸ»ãƒ»åˆ†æ</p>
                <div class="btn-group">
                    <button class="btn bg-purple" onclick="updateStatus('test_start')"><i>ğŸ’‰</i>æ¤œæŸ»é–‹å§‹</button>
                    <button class="btn bg-purple" onclick="updateStatus('test_add')"><i>â•</i>è¿½åŠ æ¤œæŸ»</button>
                    <button class="btn bg-orange" onclick="updateStatus('image_wait')"><i>â˜¢ï¸</i>ç”»åƒå‘¼å‡ºå¾…ã¡</button>
                    <button class="btn bg-blue" onclick="updateStatus('analyzing')"><i>ğŸ”¬</i>çµæœåˆ†æä¸­</button>
                </div>
                
                <p style="color:#aaa; font-size:0.8rem; margin-bottom:8px; border-left:3px solid #555; padding-left:8px;">æ¡ˆå†…ãƒ»å¾…æ©Ÿ</p>
                <div class="btn-group">
                    <button class="btn bg-yellow" onclick="updateStatus('long_wait')"><i>â³</i>æ™‚é–“ã‹ã‹ã‚Šã¾ã™</button>
                    <button class="btn bg-green" onclick="updateStatus('explain_15')"><i>ğŸ•</i>ã‚ã¨15åˆ†ã§èª¬æ˜</button>
                    <button class="btn bg-green" onclick="updateStatus('er_wait')"><i>ğŸ’º</i>å¾…åˆå®¤ã¸</button>
                </div>

                <p style="color:#aaa; font-size:0.8rem; margin-bottom:8px; border-left:3px solid #555; padding-left:8px;">ç§»å‹•ãƒ»çµ‚äº†</p>
                <div class="btn-group">
                    <button class="btn bg-ward" onclick="updateStatus('ward')"><i>ğŸ›ï¸</i>ã¾ã‚‚ãªãç—…æ£Ÿã¸</button>
                    <button class="btn bg-grey" onclick="updateStatus('end')"><i>ğŸ”š</i>å—ä»˜çµ‚äº† (åˆ‡æ–­)</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="patient-app">
    <div class="phone-container">
        <div class="p-header">æ•‘æ€¥å¤–æ¥ çŠ¶æ³æ¡ˆå†…</div>
        <div class="p-body" id="p-view-body">
            <div class="p-badge">æ•´ç†ç•ªå· No.<span id="p-num">--</span></div>
            <div id="p-content-area">
                <span class="p-icon">ğŸ“·</span>
                <div class="p-title">QRèª­å–å¾…æ©Ÿ</div>
                <div class="p-msg">çŠ¶æ³æ›´æ–°ã‚’å¾…ã£ã¦ã„ã¾ã™...</div>
            </div>
            <div class="p-time" id="p-time"></div>
            <div style="font-size:0.6rem; color:#ccc; margin-top:10px; opacity:0.5;">Secure Session Active</div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // ==========================================================
    // â˜…é‡è¦: ã“ã“ã«ã‚ãªãŸã®Firebase Configã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„â˜…
    // ==========================================================
    const firebaseConfig = {
      apiKey: "AIzaSyBqjMZAaCD7h4E6QUyHsxzU4ghryCKhy2k",
      authDomain: "hospital-family-pager.firebaseapp.com",
      projectId: "hospital-family-pager",
      storageBucket: "hospital-family-pager.firebasestorage.app",
      messagingSenderId: "866783025354",
      appId: "1:866783025354:web:a991e3844b31a0a2197c33",
      measurementId: "G-51EFLJLJ18"
    };

    // --- CONSTANTS ---
    const TOTAL_CARDS = 50;
    const STATUS_MAP = {
        'initial':    { icon: 'ğŸ¥', title: 'å—ä»˜å®Œäº†', desc: 'é †ç•ªã«ãƒˆãƒªã‚¢ãƒ¼ã‚¸ãƒ»è¨ºå¯Ÿã®æº–å‚™ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚ãã®ã¾ã¾ãŠå¾…ã¡ãã ã•ã„ã€‚', alert: false },
        'exam_start': { icon: 'ğŸ‘¨â€âš•ï¸', title: 'è¨ºå¯ŸãŒå§‹ã¾ã‚Šã¾ã—ãŸ', desc: 'åŒ»å¸«ã«ã‚ˆã‚‹è¨ºå¯ŸãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸã€‚å¾…åˆå®¤ã§ãŠå¾…ã¡ãã ã•ã„ã€‚', alert: false },
        'emergency':  { icon: 'ğŸš‘', title: 'ç·Šæ€¥å‡¦ç½®ä¸­', desc: 'ç·Šæ€¥ã®å‡¦ç½®ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚å¯¾å¿œã«ãŠæ™‚é–“ã‚’é ‚ãã¾ã™ã€‚', alert: true },
        'test_start': { icon: 'ğŸ’‰', title: 'æ¤œæŸ»å®Ÿæ–½ä¸­', desc: 'è¡€æ¶²æ¤œæŸ»ã‚„ç”Ÿç†æ©Ÿèƒ½æ¤œæŸ»ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚', alert: false },
        'test_add':   { icon: 'â•', title: 'è¿½åŠ æ¤œæŸ»', desc: 'è©³ç´°ã«èª¿ã¹ã‚‹ãŸã‚ã€è¿½åŠ ã®æ¤œæŸ»ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚', alert: false },
        'image_wait': { icon: 'â˜¢ï¸', title: 'ç”»åƒæ¤œæŸ» å¾…æ©Ÿ', desc: 'CTãƒ»ãƒ¬ãƒ³ãƒˆã‚²ãƒ³ç­‰ã®æ¤œæŸ»å¾…ã¡ã§ã™ã€‚æŠ€å¸«ã‹ã‚‰ã®å‘¼ã³å‡ºã—ã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚', alert: false },
        'analyzing':  { icon: 'ğŸ”¬', title: 'çµæœåˆ†æä¸­', desc: 'æ¤œæŸ»çµæœãŒå‡ºã¾ã—ãŸã€‚åŒ»å¸«ãŒå†…å®¹ã‚’ç¢ºèªãƒ»åˆ†æã—ã¦ã„ã¾ã™ã€‚', alert: false },
        'long_wait':  { icon: 'â³', title: 'å¾…æ©Ÿä¸­', desc: 'ç¾åœ¨ã€å‡¦ç½®ã‚„æ¤œæŸ»ã«ãŠæ™‚é–“ã‚’é ‚ã„ã¦ã„ã¾ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚', alert: false },
        'explain_15': { icon: 'ğŸ•', title: 'ã¾ã‚‚ãªãèª¬æ˜', desc: 'ã‚ã¨15åˆ†ã»ã©ã§åŒ»å¸«ã‚ˆã‚Šèª¬æ˜ã‚’è¡Œã†äºˆå®šã§ã™ã€‚å¾…åˆå®¤ã§ãŠå¾…ã¡ãã ã•ã„ã€‚', alert: false },
        'er_wait':    { icon: 'ğŸ’º', title: 'å¾…åˆå®¤ã¸', desc: 'æ•‘æ€¥å¤–æ¥ã®å¾…åˆå®¤ã¸ç§»å‹•ã—ã¦ãŠå¾…ã¡ãã ã•ã„ã€‚', alert: false },
        'ward':       { icon: 'ğŸ›ï¸', title: 'ã¾ã‚‚ãªãç—…æ£Ÿã¸', desc: 'å…¥é™¢ï¼ˆç—…æ£Ÿç§»å‹•ï¼‰ã®æº–å‚™ãŒæ•´ã„ã¾ã—ãŸã€‚ç§»å‹•ã‚’é–‹å§‹ã—ã¾ã™ã€‚', alert: false },
        'custom':     { icon: 'ğŸ“©', title: 'ãŠçŸ¥ã‚‰ã›', desc: '', alert: false },
        'end':        { icon: 'âœ…', title: 'çµ‚äº†', desc: 'æœ¬æ—¥ã®å—ä»˜é€šçŸ¥ã¯çµ‚äº†ã—ã¾ã—ãŸã€‚', alert: false }
    };

    // --- HELPERS ---
    const generateSessionId = () => Math.random().toString(36).substring(2, 12);
    const getNowStr = () => { const now = new Date(); return `${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`; };

    // --- APP STATE ---
    let db, auth;
    let cardCache = {};
    window.selectedCardId = null;

    // --- INITIALIZATION ---
    try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        
        // Realtime Listener
        onSnapshot(collection(db, 'cards'), (snapshot) => {
            document.getElementById('sys-status').innerText = "Server: Connected (Tokyo)";
            
            snapshot.docChanges().forEach((change) => {
                cardCache[change.doc.id] = change.doc.data();
            });

            // Trigger Re-renders
            if (document.body.classList.contains('mode-staff')) {
                renderStaffGrid();
                if (window.selectedCardId) renderPreview(window.selectedCardId);
            } else if (document.body.classList.contains('mode-patient')) {
                const myId = document.getElementById('p-num').innerText;
                if (myId && myId !== '--') syncPatientView(myId);
            }
        }, (err) => {
            console.error("Firestore Error:", err);
            document.getElementById('sys-status').innerText = "Server: Error (Check Config)";
        });

    } catch (e) {
        console.error("Init Error:", e);
        document.getElementById('sys-status').innerText = "Error: Config Missing?";
    }

    // --- MODE SWITCHER ---
    window.addEventListener('DOMContentLoaded', () => {
        const myId = new URLSearchParams(window.location.search).get('id');
        if (myId) initPatientMode(myId); 
        else initStaffMode();
    });

    // ==========================================
    // 1. STAFF LOGIC (Secure & Layout Optimized)
    // ==========================================
    function initStaffMode() {
        document.body.classList.add('mode-staff');
        
        // Auth Listener
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('auth-display').innerText = `User: ${user.email}`;
                renderStaffGrid();
            } else {
                performStaffLogin();
            }
        });
    }

    function performStaffLogin() {
        const email = prompt("ã€è·å“¡èªè¨¼ã€‘ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›:", "");
        const password = prompt("ã€è·å“¡èªè¨¼ã€‘ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›:", "");
        if (email && password) {
            signInWithEmailAndPassword(auth, email, password)
                .then(() => alert("èªè¨¼æˆåŠŸ: ã‚·ã‚¹ãƒ†ãƒ ã«æ¥ç¶šã—ã¾ã—ãŸ"))
                .catch((e) => { alert("èªè¨¼å¤±æ•—: " + e.message); location.reload(); });
        } else {
            alert("åˆ©ç”¨ã«ã¯ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™");
        }
    }

    function renderStaffGrid() {
        const grid = document.getElementById('s-grid');
        grid.innerHTML = '';
        for (let i = 1; i <= TOTAL_CARDS; i++) {
            const btn = document.createElement('div');
            btn.className = 's-card';
            btn.innerText = i;
            const data = cardCache[i];
            
            // Dynamic Coloring
            if (data && data.status) {
                if (data.status === 'initial') btn.classList.add('st-initial');
                else if (data.status === 'end') btn.classList.add('st-end');
                else btn.classList.add('st-' + data.status);
            }
            if (i == window.selectedCardId) btn.classList.add('active');
            
            btn.onclick = () => selectStaffCard(i);
            grid.appendChild(btn);
        }
    }

    function selectStaffCard(id) {
        window.selectedCardId = id;
        document.getElementById('s-target-num').innerText = id;
        document.getElementById('custom-msg-input').value = '';
        
        // Unlock Controls
        const controls = document.getElementById('s-controls');
        controls.style.opacity = 1;
        controls.style.pointerEvents = 'auto';
        
        renderStaffGrid();
        renderPreview(id);
    }

    function renderPreview(id) {
        const data = cardCache[id];
        const screen = document.getElementById('prev-screen');
        
        // Reset Logic
        screen.className = 'preview-body';
        
        if (!data || !data.status) {
            screen.innerHTML = `<span class="prev-icon">ğŸ“·</span><div class="prev-title">æœªæ¥ç¶š</div><div class="prev-msg">QRèª­å–å¾…æ©Ÿä¸­</div>`;
            return;
        }
        if (data.status === 'end') {
            screen.classList.add('mode-end');
            screen.innerHTML = `<span class="prev-icon">ğŸ”š</span><div class="prev-title">çµ‚äº†</div><div class="prev-msg">å—ä»˜çµ‚äº†ã—ã¾ã—ãŸ</div>`;
            return;
        }

        let icon='', title='', desc='';
        if (data.status === 'custom') {
            screen.classList.add('mode-custom');
            const def = STATUS_MAP['custom']; icon = def.icon; title = def.title; desc = data.message || '(ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã—)';
        } else {
            const info = STATUS_MAP[data.status] || STATUS_MAP['initial'];
            if (info.alert) screen.classList.add('mode-alert');
            if (data.status === 'ward') screen.classList.add('mode-ward'); // ç—…æ£Ÿç”¨ã‚¹ã‚¿ã‚¤ãƒ«
            icon = info.icon; title = info.title; desc = info.desc;
        }
        
        // Truncate for preview
        if(desc.length > 25) desc = desc.substring(0, 25) + '...';
        
        screen.innerHTML = `<span class="prev-icon">${icon}</span><div class="prev-title">${title}</div><div class="prev-msg">${desc}</div>`;
    }

    // --- WRITER FUNCTIONS (Exposed to Global) ---
    window.updateStatus = (statusKey) => { if (window.selectedCardId) saveStatusToCloud(statusKey, null); };
    window.sendCustomMessage = () => {
        if (!window.selectedCardId) return;
        const text = document.getElementById('custom-msg-input').value.trim();
        if (!text) return alert("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        saveStatusToCloud('custom', text);
    };

    async function saveStatusToCloud(statusKey, customText) {
        if (!db) return;
        const id = window.selectedCardId;
        const currentData = cardCache[id] || {};
        
        // SESSION LOGIC: Force new session if currently empty/ended
        let currentSess = currentData.sessionId;
        if (!currentSess || currentData.status === 'end' || !currentData.status) {
            currentSess = generateSessionId();
        }

        const payload = {
            status: statusKey,
            time: getNowStr(),
            message: customText,
            sessionId: currentSess
        };

        try {
            await setDoc(doc(db, "cards", String(id)), payload, { merge: true });
        } catch(e) {
            console.error(e);
            alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼: ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„");
        }
    }

    // ==========================================
    // 2. PATIENT LOGIC (Auto-Checkin & Secure)
    // ==========================================
    let myHeldSessionId = null; 

    function initPatientMode(id) {
        document.body.classList.add('mode-patient');
        document.getElementById('p-num').innerText = id;

        // 1. Session Persistence (Prevents Ghost Re-connect)
        const storedSess = sessionStorage.getItem('er_sess_' + id);
        if (storedSess) myHeldSessionId = storedSess;

        // 2. Auto Check-in (Delayed to ensure DB connection)
        setTimeout(() => checkInPatient(id), 1500);
    }

    async function checkInPatient(id) {
        if (!db) return;
        const data = cardCache[id] || {};

        // Only check-in if: I have no session AND the slot is free/ended
        if (!myHeldSessionId && (!data.status || data.status === 'end')) {
            const newSess = generateSessionId();
            myHeldSessionId = newSess;
            sessionStorage.setItem('er_sess_' + id, newSess);
            
            try {
                // Rule: Unauthenticated user can ONLY write if status == 'initial'
                await setDoc(doc(db, "cards", String(id)), {
                    status: 'initial',
                    time: getNowStr(),
                    sessionId: newSess,
                    message: null
                });
            } catch(e) { console.error("Check-in blocked (Normal if slot busy)", e); }
        }
        
        // Force initial render
        syncPatientView(id);
    }

    function syncPatientView(id) {
        const data = cardCache[id];
        const container = document.getElementById('patient-app');
        const contentArea = document.getElementById('p-content-area');
        
        // Reset Classes
        container.className = ''; 
        document.getElementById('p-view-body').className = 'p-body';

        if (!data || !data.status) { 
            contentArea.innerHTML = `<span class="p-icon">ğŸ¤”</span><div class="p-title">æœªç™»éŒ²</div><div class="p-msg">ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</div>`; 
            return; 
        }

        // â˜… GHOST CHECK â˜…
        if (myHeldSessionId && data.sessionId && data.sessionId !== myHeldSessionId) {
            renderEndScreen(contentArea, container, data.time, true);
            return;
        }

        // END STATE
        if (data.status === 'end') {
            renderEndScreen(contentArea, container, data.time, false);
            return;
        }

        // ACTIVE STATE
        let icon='', title='', desc='';
        if (data.status === 'custom') {
            container.classList.add('mode-custom');
            const def = STATUS_MAP['custom']; icon = def.icon; title = def.title; desc = data.message || '(ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã—)';
        } else {
            const info = STATUS_MAP[data.status] || STATUS_MAP['initial'];
            if (info.alert) container.classList.add('mode-alert');
            if (data.status === 'ward') container.classList.add('mode-ward'); // ç—…æ£Ÿç”¨ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨
            icon = info.icon; title = info.title; desc = info.desc;
        }
        
        contentArea.innerHTML = `<span class="p-icon">${icon}</span><div class="p-title">${title}</div><div class="p-msg">${desc}</div>`;
        document.getElementById('p-time').innerText = `æ›´æ–°: ${data.time}`;
    }

    function renderEndScreen(el, container, time, isGhost) {
        container.classList.add('mode-end');
        el.innerHTML = `<span class="p-icon">ğŸ”š</span><div class="p-title">çµ‚äº†</div><div class="p-msg" style="font-weight:bold;">${isGhost ? 'æ¥ç¶šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ<br>(æ–°ã—ã„è¨ºå¯ŸãŒé–‹å§‹ã•ã‚Œã¦ã„ã¾ã™)' : 'æœ¬æ—¥ã®å—ä»˜é€šçŸ¥ã¯çµ‚äº†ã—ã¾ã—ãŸ'}</div>`;
        document.getElementById('p-time').innerText = `æœ€çµ‚æ›´æ–°: ${time}`;
    }

</script>
</body>
</html>
