<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ERçŠ¶æ³å…±æœ‰ã‚·ã‚¹ãƒ†ãƒ  Ver.2026.01.11-v2</title>
<style>
    /* --- DESIGN SYSTEM --- */
    :root {
        --bg-staff: #2d3436;
        --bg-patient: #f5f6fa;
        --c-blue: #0984e3; --c-red: #d63031; --c-purple: #6c5ce7;
        --c-orange: #e17055; --c-yellow: #fdcb6e; --c-green: #00b894;
        --c-grey: #636e72; --c-teal: #00cec9;
        --c-ward: #8e44ad;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Yu Gothic", sans-serif; }
    body { height: 100vh; overflow: hidden; margin: 0; }
    
    /* View Switcher */
    #staff-app, #patient-app { display: none; height: 100%; width: 100%; }
    body.mode-staff #staff-app { display: flex; }
    body.mode-patient #patient-app { display: flex; }

    /* === STAFF UI === */
    #staff-app { background: var(--bg-staff); color: white; flex-direction: column; }
    .staff-header { padding: 15px; background: #000; border-bottom: 1px solid #555; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
    .staff-body { flex: 1; display: flex; overflow: hidden; }
    
    /* Card Grid */
    .card-list { width: 280px; background: #222; padding: 10px; overflow-y: auto; border-right: 1px solid #555; display: grid; grid-template-columns: repeat(4, 1fr); grid-auto-rows: 55px; gap: 6px; flex-shrink: 0; }
    .s-card { background: #444; border: 2px solid #555; border-radius: 5px; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; color: #aaa; font-size: 1.1rem; user-select: none; position: relative; transition: all 0.2s; }
    .s-card:hover { filter: brightness(1.2); }
    .s-card.active { border-color: white; box-shadow: 0 0 0 2px white inset; z-index: 10; }
    
    /* Status Colors */
    .s-card.st-initial { border: 2px solid var(--c-green); color: white; background: #2d3436; }
    .s-card.st-initial::after { content: 'READY'; position: absolute; bottom: 2px; font-size: 0.5rem; color: var(--c-green); }
    
    .s-card.st-exam_start, .s-card.st-analyzing { background: var(--c-blue); color: white; border: none; }
    .s-card.st-emergency { background: var(--c-red); color: white; border: none; animation: pulse 1s infinite; }
    .s-card.st-test_start, .s-card.st-test_add { background: var(--c-purple); color: white; border: none; }
    .s-card.st-image_wait { background: var(--c-orange); color: white; border: none; }
    .s-card.st-long_wait { background: var(--c-yellow); color: #333; border: none; }
    .s-card.st-explain_15, .s-card.st-er_wait { background: var(--c-green); color: white; border: none; }
    .s-card.st-ward { background: var(--c-ward); color: white; border: none; }
    .s-card.st-custom { background: var(--c-teal); color: #333; border: none; }
    .s-card.st-end { opacity: 0.4; }

    /* Controls */
    .controls { flex: 1; padding: 20px; overflow-y: auto; background: #2d3436; display: flex; flex-direction: column; gap: 20px; }
    @media (min-width: 768px) {
        .controls { display: grid; grid-template-columns: 380px 1fr; grid-template-rows: 1fr; gap: 30px; align-items: start; overflow-y: hidden; }
        .controls-right-panel { overflow-y: auto; max-height: 100%; padding-right: 5px; }
        .preview-area { flex-direction: row; text-align: left; }
        .preview-info { margin-bottom: 0; margin-right: 20px; }
    }
    
    .preview-area { background: #1a1a1a; padding: 15px; border-radius: 12px; display: flex; flex-direction: column; align-items: center; border: 1px solid #444; text-align: center; }
    .preview-info { flex: 1; margin-bottom: 15px; }
    .preview-phone { width: 160px; height: 280px; background: white; border-radius: 16px; border: 5px solid #333; overflow: hidden; position: relative; display: flex; flex-direction: column; box-shadow: 0 4px 10px rgba(0,0,0,0.3); margin: 0 auto; }
    .preview-header { background: #2d3436; height: 25px; width: 100%; flex-shrink: 0; }
    .preview-body { flex: 1; padding: 8px; display: flex; flex-direction: column; align-items: center; text-align: center; color: #333; overflow: hidden; justify-content: center; }
    .prev-icon { font-size: 3rem; margin-bottom: 8px; display: block; line-height: 1; }
    .prev-title { font-size: 0.9rem; font-weight: 800; margin-bottom: 4px; line-height: 1.2; color: #2d3436; }
    .prev-msg { font-size: 0.65rem; color: #636e72; background: #f1f2f6; padding: 6px; border-radius: 6px; width: 100%; line-height: 1.4; margin-bottom: 5px; }
    .prev-time { font-size: 0.7rem; font-weight: bold; color: #d63031; border-top: 1px dashed #ccc; width: 100%; padding-top: 4px; margin-top: 4px; }
    
    .preview-body.mode-alert { background: #fff5f5; } .preview-body.mode-alert .prev-title { color: var(--c-red); }
    .preview-body.mode-custom { background: #e0f7fa; } .preview-body.mode-custom .prev-title { color: #006064; }
    .preview-body.mode-ward { background: #f3e5f5; } .preview-body.mode-ward .prev-title { color: var(--c-ward); }
    .preview-body.mode-end { background: #eee; } .preview-body.mode-end .prev-icon { opacity: 0.3; }

    .custom-input-area { background: #3a4244; padding: 15px; border-radius: 8px; border: 1px solid #555; }
    .custom-input-row { display: flex; gap: 10px; margin-top: 10px; }
    input[type="text"] { flex: 1; padding: 12px; border-radius: 6px; border: none; font-size: 1rem; outline: none; }
    .btn-send { background: var(--c-teal); color: #2d3436; font-weight: bold; cursor: pointer; padding: 0 20px; border: none; border-radius: 6px; }
    
    .btn-group { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-bottom: 20px; }
    .btn { padding: 12px; border: none; border-radius: 8px; color: white; font-weight: bold; font-size: 0.9rem; cursor: pointer; text-align: left; display: flex; align-items: center; transition: transform 0.1s, filter 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .btn:hover { filter: brightness(1.1); transform: translateY(-1px); }
    .btn:active { transform: scale(0.98); }
    .btn i { font-size: 1.3rem; margin-right: 10px; width: 25px; text-align: center; }
    
    .bg-blue { background: var(--c-blue); } .bg-red { background: var(--c-red); } .bg-purple { background: var(--c-purple); }
    .bg-orange { background: var(--c-orange); } .bg-yellow { background: var(--c-yellow); color: #333; } .bg-green { background: var(--c-green); } .bg-grey { background: var(--c-grey); }
    .bg-ward { background: var(--c-ward); }
    .bg-reset { background: #34495e; border: 2px solid #555; }

    /* === PATIENT UI === */
    #patient-app { background: var(--bg-patient); flex-direction: column; align-items: center; justify-content: center; }
    .phone-container { width: 100%; max-width: 480px; height: 100%; background: white; display: flex; flex-direction: column; box-shadow: 0 0 30px rgba(0,0,0,0.1); }
    .p-header { background: #2d3436; color: white; padding: 18px; text-align: center; font-weight: bold; font-size: 1.1rem; }
    .p-body { flex: 1; padding: 30px; display: flex; flex-direction: column; align-items: center; text-align: center; overflow-y: auto; position: relative;}
    .p-badge { background: #dfe6e9; padding: 6px 16px; border-radius: 20px; font-weight: bold; color: #636e72; margin-bottom: 30px; font-size: 0.9rem; }
    .p-icon { font-size: 7rem; margin: 10px 0 20px; display: block; line-height: 1; }
    .p-title { font-size: 2rem; font-weight: 800; color: #2d3436; margin-bottom: 20px; line-height: 1.3; }
    
    .p-info-box { background: #f1f2f6; padding: 20px; border-radius: 12px; width: 100%; margin-top: auto; border: 1px solid #e1e1e1; }
    .p-msg { font-size: 1.1rem; color: #636e72; line-height: 1.6; margin-bottom: 15px; word-break: break-all; }
    .p-time { font-size: 1.2rem; font-weight: bold; color: #d63031; border-top: 2px dashed #ccc; padding-top: 10px; width: 100%; display: block; }
    
    .mode-alert .p-body { background: #fff5f5; } .mode-alert .p-title { color: var(--c-red); }
    .mode-custom .p-body { background: #e0f7fa; } .mode-custom .p-title { color: #006064; }
    .mode-ward .p-body { background: #f3e5f5; } .mode-ward .p-title { color: var(--c-ward); }
    .mode-end .p-body { background: #eee; justify-content: center; } .mode-end .p-icon { opacity: 0.2; } .mode-end .p-title { color: #aaa; }
    
    /* Connect Button */
    .btn-connect {
        background: var(--c-blue); color: white; border: none; padding: 15px 30px;
        border-radius: 50px; font-size: 1.2rem; font-weight: bold; cursor: pointer;
        box-shadow: 0 4px 15px rgba(9, 132, 227, 0.4); animation: pulse 2s infinite;
        margin-top: 20px;
    }

    /* Sound Button */
    #sound-enable-overlay {
        position: absolute; bottom: 80px; z-index: 100;
        background: var(--c-blue); color: white; padding: 10px 20px;
        border-radius: 30px; font-weight: bold; cursor: pointer;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3); animation: bounce 2s infinite;
        display: none;
    }
    
    /* Offline Banner */
    .offline-banner {
        display: none;
        background: var(--c-red);
        color: white;
        text-align: center;
        padding: 8px;
        font-size: 0.85rem;
        font-weight: bold;
    }
    body.is-offline .offline-banner { display: block; }
    
    /* Connection Status Indicator */
    .conn-dot {
        width: 8px; height: 8px; border-radius: 50%;
        display: inline-block; margin-right: 5px;
    }
    .conn-dot.online { background: var(--c-green); }
    .conn-dot.offline { background: var(--c-red); animation: pulse 1s infinite; }
    
    @keyframes bounce { 0%, 100% {transform: translateY(0);} 50% {transform: translateY(-5px);} }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }

    /* Clear Block Link - Hidden by default, requires specific action */
    .clear-block-link { 
        margin-top: 30px; font-size: 0.8rem; color: #0984e3; 
        text-decoration: underline; cursor: pointer; opacity: 0.7; 
    }
    .clear-block-link:hover { opacity: 1; }

</style>
</head>
<body>

<div class="offline-banner">âš ï¸ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ - æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„</div>

<div id="staff-app">
    <div class="staff-header">
        <h2>ğŸ¥ ER Status Console</h2>
        <div style="font-size:0.8rem; color:#aaa; display:flex; gap:10px; align-items:center;">
            <span id="auth-display">Auth: Checking...</span>
            <span id="sys-status"><span class="conn-dot offline"></span>Connecting...</span>
        </div>
    </div>
    <div class="staff-body">
        <div class="card-list" id="s-grid"></div>
        
        <div class="controls" id="s-controls" style="opacity:0.3; pointer-events:none;">
            <div class="controls-left-panel">
                <div class="preview-area">
                    <div class="preview-info">
                        <div style="font-size:1.2rem; margin-bottom:10px; border-bottom:1px solid #555; padding-bottom:5px;">
                            å¯¾è±¡: <span id="s-target-num" style="color:var(--c-blue); font-weight:bold;">--</span>
                        </div>
                        <p style="font-size:0.8rem; color:#aaa; line-height:1.4;">
                            <span style="color:var(--c-green);">â—</span> æ‚£è€…ç”»é¢ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼<br>
                            (ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸä¸­)
                        </p>
                    </div>
                    <div class="preview-phone">
                        <div class="preview-header"></div>
                        <div class="preview-body" id="prev-screen">
                            <span class="prev-icon">ğŸ“·</span>
                            <div class="prev-title">æœªæ¥ç¶š</div>
                            <div class="prev-msg">QRèª­å–å¾…æ©Ÿä¸­</div>
                            <div class="prev-time">æ›´æ–°: --:--</div>
                        </div>
                    </div>
                </div>

                <div class="custom-input-area">
                    <div style="font-size:0.85rem; color:#ccc; font-weight:bold;">ğŸ“© è‡ªç”±è¨˜è¿°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>
                    <div class="custom-input-row">
                        <input type="text" id="custom-msg-input" placeholder="ä¾‹: 1ç•ªè¨ºå¯Ÿå®¤ã®å‰ã¸">
                        <button class="btn-send" onclick="App.sendCustomMessage()">é€ä¿¡</button>
                    </div>
                </div>
            </div>
            
            <div class="controls-right-panel">
                <p style="color:#aaa; font-size:0.8rem; margin-bottom:8px; border-left:3px solid #555; padding-left:8px;">è¨ºå¯Ÿãƒ»å‡¦ç½®çŠ¶æ³</p>
                <div class="btn-group">
                    <button class="btn bg-blue" onclick="App.updateStatus('exam_start')"><i>ğŸ‘¨â€âš•ï¸</i>è¨ºå¯Ÿé–‹å§‹</button>
                    <button class="btn bg-red" onclick="App.updateStatus('emergency')"><i>ğŸš‘</i>ç·Šæ€¥å‡¦ç½®ä¸­</button>
                </div>
                
                <p style="color:#aaa; font-size:0.8rem; margin-bottom:8px; border-left:3px solid #555; padding-left:8px;">æ¤œæŸ»ãƒ»åˆ†æ</p>
                <div class="btn-group">
                    <button class="btn bg-purple" onclick="App.updateStatus('test_start')"><i>ğŸ’‰</i>æ¤œæŸ»é–‹å§‹</button>
                    <button class="btn bg-purple" onclick="App.updateStatus('test_add')"><i>â•</i>è¿½åŠ æ¤œæŸ»</button>
                    <button class="btn bg-orange" onclick="App.updateStatus('image_wait')"><i>â˜¢ï¸</i>ç”»åƒå‘¼å‡ºå¾…ã¡</button>
                    <button class="btn bg-blue" onclick="App.updateStatus('analyzing')"><i>ğŸ”¬</i>çµæœåˆ†æä¸­</button>
                </div>
                
                <p style="color:#aaa; font-size:0.8rem; margin-bottom:8px; border-left:3px solid #555; padding-left:8px;">æ¡ˆå†…ãƒ»å¾…æ©Ÿ</p>
                <div class="btn-group">
                    <button class="btn bg-yellow" onclick="App.updateStatus('long_wait')"><i>â³</i>æ™‚é–“ã‹ã‹ã‚Šã¾ã™</button>
                    <button class="btn bg-green" onclick="App.updateStatus('explain_15')"><i>ğŸ•</i>ã‚ã¨15åˆ†ã§èª¬æ˜</button>
                    <button class="btn bg-green" onclick="App.updateStatus('er_wait')"><i>ğŸ’º</i>å¾…åˆå®¤ã¸</button>
                </div>

                <p style="color:#aaa; font-size:0.8rem; margin-bottom:8px; border-left:3px solid #555; padding-left:8px;">ç§»å‹•ãƒ»çµ‚äº†ãƒ»ãƒªã‚»ãƒƒãƒˆ</p>
                <div class="btn-group">
                    <button class="btn bg-ward" onclick="App.updateStatus('ward')"><i>ğŸ›ï¸</i>ã¾ã‚‚ãªãç—…æ£Ÿã¸</button>
                    <button class="btn bg-grey" onclick="App.updateStatus('end')"><i>ğŸ”š</i>å—ä»˜çµ‚äº† (åˆ‡æ–­)</button>
                    <button class="btn bg-reset" onclick="App.updateStatus('initial')"><i>ğŸ”„</i>æ¬¡ã®æ‚£è€…ã¸ (æ–°è¦)</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="patient-app">
    <div class="phone-container">
        <div class="p-header">æ•‘æ€¥å¤–æ¥ çŠ¶æ³æ¡ˆå†…</div>
        <div class="p-body" id="p-view-body">
            <div class="p-badge">æ•´ç†ç•ªå· No.<span id="p-num">--</span></div>
            <div id="p-content-area">
                <span class="p-icon">ğŸ“·</span>
                <div class="p-title">QRèª­å–å¾…æ©Ÿ</div>
                <div class="p-info-box">
                    <div class="p-msg">çŠ¶æ³æ›´æ–°ã‚’å¾…ã£ã¦ã„ã¾ã™...</div>
                    <div class="p-time">æ›´æ–°: --:--</div>
                </div>
            </div>
            <div id="sound-enable-overlay" onclick="App.unlockAudio()">ğŸ”Š é€šçŸ¥éŸ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹</div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // ==========================================================
    // â˜…é‡è¦: Firebase Config
    // ==========================================================
    const firebaseConfig = {
      apiKey: "AIzaSyBqjMZAaCD7h4E6QUyHsxzU4ghryCKhy2k",
      authDomain: "hospital-family-pager.firebaseapp.com",
      projectId: "hospital-family-pager",
      storageBucket: "hospital-family-pager.firebasestorage.app",
      messagingSenderId: "866783025354",
      appId: "1:866783025354:web:a991e3844b31a0a2197c33",
      measurementId: "G-51EFLJLJ18"
    };

    // ==========================================================
    // CONSTANTS & STATUS DEFINITIONS
    // ==========================================================
    const TOTAL_CARDS = 50;
    const BLOCK_DURATION_MS = 12 * 60 * 60 * 1000; // 12æ™‚é–“ã§ãƒ–ãƒ­ãƒƒã‚¯è‡ªå‹•è§£é™¤
    
    const STATUS_MAP = {
        'initial':    { icon: 'ğŸ¥', title: 'å¾…æ©Ÿä¸­', desc: 'ã“ã®ç•ªå·ã§æ¥ç¶šã—ã¾ã™ã‹ï¼Ÿ<br>ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦é–‹å§‹ã—ã¦ãã ã•ã„ã€‚', alert: false },
        'exam_start': { icon: 'ğŸ‘¨â€âš•ï¸', title: 'è¨ºå¯ŸãŒå§‹ã¾ã‚Šã¾ã—ãŸ', desc: 'åŒ»å¸«ã«ã‚ˆã‚‹è¨ºå¯ŸãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸã€‚å¾…åˆå®¤ã§ãŠå¾…ã¡ãã ã•ã„ã€‚', alert: false },
        'emergency':  { icon: 'ğŸš‘', title: 'ç·Šæ€¥å‡¦ç½®ä¸­', desc: 'ç·Šæ€¥ã®å‡¦ç½®ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚å¯¾å¿œã«ãŠæ™‚é–“ã‚’é ‚ãã¾ã™ã€‚', alert: true },
        'test_start': { icon: 'ğŸ’‰', title: 'æ¤œæŸ»å®Ÿæ–½ä¸­', desc: 'è¡€æ¶²æ¤œæŸ»ã‚„ç”Ÿç†æ©Ÿèƒ½æ¤œæŸ»ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚', alert: false },
        'test_add':   { icon: 'â•', title: 'è¿½åŠ æ¤œæŸ»', desc: 'è©³ç´°ã«èª¿ã¹ã‚‹ãŸã‚ã€è¿½åŠ ã®æ¤œæŸ»ã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚', alert: false },
        'image_wait': { icon: 'â˜¢ï¸', title: 'ç”»åƒæ¤œæŸ» å¾…æ©Ÿ', desc: 'CTãƒ»ãƒ¬ãƒ³ãƒˆã‚²ãƒ³ç­‰ã®æ¤œæŸ»å¾…ã¡ã§ã™ã€‚æŠ€å¸«ã‹ã‚‰ã®å‘¼ã³å‡ºã—ã‚’ãŠå¾…ã¡ãã ã•ã„ã€‚', alert: false },
        'analyzing':  { icon: 'ğŸ”¬', title: 'çµæœåˆ†æä¸­', desc: 'æ¤œæŸ»çµæœãŒå‡ºã¾ã—ãŸã€‚åŒ»å¸«ãŒå†…å®¹ã‚’ç¢ºèªãƒ»åˆ†æã—ã¦ã„ã¾ã™ã€‚', alert: false },
        'long_wait':  { icon: 'â³', title: 'å¾…æ©Ÿä¸­', desc: 'ç¾åœ¨ã€å‡¦ç½®ã‚„æ¤œæŸ»ã«ãŠæ™‚é–“ã‚’é ‚ã„ã¦ã„ã¾ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚', alert: false },
        'explain_15': { icon: 'ğŸ•', title: 'ã¾ã‚‚ãªãèª¬æ˜', desc: 'ã‚ã¨15åˆ†ã»ã©ã§åŒ»å¸«ã‚ˆã‚Šèª¬æ˜ã‚’è¡Œã†äºˆå®šã§ã™ã€‚å¾…åˆå®¤ã§ãŠå¾…ã¡ãã ã•ã„ã€‚', alert: false },
        'er_wait':    { icon: 'ğŸ’º', title: 'å¾…åˆå®¤ã¸', desc: 'æ•‘æ€¥å¤–æ¥ã®å¾…åˆå®¤ã¸ç§»å‹•ã—ã¦ãŠå¾…ã¡ãã ã•ã„ã€‚', alert: false },
        'ward':       { icon: 'ğŸ›ï¸', title: 'ã¾ã‚‚ãªãç—…æ£Ÿã¸', desc: 'å…¥é™¢ï¼ˆç—…æ£Ÿç§»å‹•ï¼‰ã®æº–å‚™ãŒæ•´ã„ã¾ã—ãŸã€‚ç§»å‹•ã‚’é–‹å§‹ã—ã¾ã™ã€‚', alert: false },
        'custom':     { icon: 'ğŸ“©', title: 'ãŠçŸ¥ã‚‰ã›', desc: '', alert: false },
        'end':        { icon: 'âœ…', title: 'çµ‚äº†', desc: 'æœ¬æ—¥ã®å—ä»˜é€šçŸ¥ã¯çµ‚äº†ã—ã¾ã—ãŸã€‚', alert: false }
    };

    // ==========================================================
    // [NEW] ACCESS STATE ENUM - çŠ¶æ…‹ã‚’æ˜ç¢ºã«åˆ†é¡
    // ==========================================================
    const AccessState = Object.freeze({
        NOT_REGISTERED: 'NOT_REGISTERED',  // ã‚µãƒ¼ãƒãƒ¼ã«ãƒ‡ãƒ¼ã‚¿ãªã—
        CAN_JOIN:       'CAN_JOIN',        // æ¥ç¶šå¯èƒ½ï¼ˆinitialã§æœªæ¥ç¶šï¼‰
        ACTIVE:         'ACTIVE',          // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ¥ç¶šä¸­
        EXPIRED:        'EXPIRED',         // ã‚»ãƒƒã‚·ãƒ§ãƒ³æœŸé™åˆ‡ã‚Œï¼ˆã‚´ãƒ¼ã‚¹ãƒˆï¼‰
        BLOCKED:        'BLOCKED',         // ãƒ–ãƒ­ãƒƒã‚¯ä¸­ï¼ˆå†åˆ©ç”¨ç¦æ­¢ï¼‰
        ENDED:          'ENDED',           // æ­£å¸¸çµ‚äº†
        NO_ACCESS:      'NO_ACCESS'        // ã‚¢ã‚¯ã‚»ã‚¹æ¨©ãªã—
    });

    // ==========================================================
    // [NEW] STATE MACHINE - è¨±å¯ã•ã‚Œã‚‹çŠ¶æ…‹é·ç§»ã‚’å®šç¾©
    // ==========================================================
    const StateMachine = {
        transitions: {
            [AccessState.NOT_REGISTERED]: [AccessState.CAN_JOIN, AccessState.NOT_REGISTERED],
            [AccessState.CAN_JOIN]:       [AccessState.ACTIVE, AccessState.CAN_JOIN, AccessState.NOT_REGISTERED],
            [AccessState.ACTIVE]:         [AccessState.ACTIVE, AccessState.ENDED, AccessState.EXPIRED],
            [AccessState.ENDED]:          [AccessState.CAN_JOIN, AccessState.BLOCKED],
            [AccessState.EXPIRED]:        [AccessState.BLOCKED, AccessState.CAN_JOIN],
            [AccessState.BLOCKED]:        [AccessState.CAN_JOIN],
            [AccessState.NO_ACCESS]:      [AccessState.CAN_JOIN, AccessState.NO_ACCESS]
        },
        
        canTransition(from, to) {
            return this.transitions[from]?.includes(to) ?? false;
        },
        
        validate(from, to) {
            if (!this.canTransition(from, to)) {
                console.warn(`[StateMachine] Invalid transition: ${from} â†’ ${to}`);
                return false;
            }
            return true;
        }
    };

    // ==========================================================
    // AUDIO SYSTEM
    // ==========================================================
    const AudioSystem = {
        ctx: null,
        unlocked: false,
        
        unlock() {
            if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            return this.ctx.resume().then(() => {
                this.unlocked = true;
                document.getElementById('sound-enable-overlay').style.display = 'none';
                this.playTone(880, 0.1, 0.05);
            });
        },
        
        playNotification() {
            if (!this.unlocked || !this.ctx) return;
            this.playTone(660, 0.2, 0);
            setTimeout(() => this.playTone(550, 0.4, 0), 200);
        },
        
        playTone(freq, duration, delay) {
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.connect(gain);
            gain.connect(this.ctx.destination);
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(0.1, this.ctx.currentTime);
            osc.start(this.ctx.currentTime + delay);
            osc.stop(this.ctx.currentTime + delay + duration);
        }
    };

    // ==========================================================
    // [NEW] BLOCK MANAGER - æ™‚é–“ãƒ™ãƒ¼ã‚¹ã®ãƒ–ãƒ­ãƒƒã‚¯ç®¡ç†
    // ==========================================================
    const BlockManager = {
        _getKey(id) { return `er_block_${id}`; },
        
        setBlock(id, sessionId) {
            const data = { sessionId, timestamp: Date.now() };
            localStorage.setItem(this._getKey(id), JSON.stringify(data));
        },
        
        getBlock(id) {
            try {
                const raw = localStorage.getItem(this._getKey(id));
                if (!raw) return null;
                const data = JSON.parse(raw);
                
                // æ™‚é–“çµŒéã§ãƒ–ãƒ­ãƒƒã‚¯è‡ªå‹•è§£é™¤
                if (Date.now() - data.timestamp > BLOCK_DURATION_MS) {
                    this.clearBlock(id);
                    return null;
                }
                return data;
            } catch { return null; }
        },
        
        isBlocked(id, serverSessionId) {
            const block = this.getBlock(id);
            return block && block.sessionId === serverSessionId;
        },
        
        clearBlock(id) {
            localStorage.removeItem(this._getKey(id));
        }
    };

    // ==========================================================
    // [NEW] SESSION MANAGER - ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®å˜ç´”åŒ–
    // ==========================================================
    const SessionManager = {
        _getKey(id) { return `er_session_${id}`; },
        
        get(id) {
            return sessionStorage.getItem(this._getKey(id));
        },
        
        set(id, sessionId) {
            sessionStorage.setItem(this._getKey(id), sessionId);
        },
        
        clear(id) {
            sessionStorage.removeItem(this._getKey(id));
        },
        
        // [CORE] çµ±ä¸€ã•ã‚ŒãŸã‚¢ã‚¯ã‚»ã‚¹çŠ¶æ…‹åˆ¤å®š
        getAccessState(id, data) {
            const myToken = this.get(id);
            const serverToken = data?.sessionId;
            
            // 1. ã‚µãƒ¼ãƒãƒ¼ã«ãƒ‡ãƒ¼ã‚¿ãªã—
            if (!data || !serverToken) {
                return AccessState.NOT_REGISTERED;
            }
            
            // 2. ãƒ–ãƒ­ãƒƒã‚¯åˆ¤å®šï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ãªã— & ãƒ–ãƒ­ãƒƒã‚¯ç™»éŒ²æ¸ˆã¿ï¼‰
            if (!myToken && BlockManager.isBlocked(id, serverToken)) {
                return AccessState.BLOCKED;
            }
            
            // 3. æ¥ç¶šå¯èƒ½ï¼ˆinitialçŠ¶æ…‹ã§æœªæ¥ç¶šï¼‰
            if (!myToken && data.status === 'initial') {
                return AccessState.CAN_JOIN;
            }
            
            // 4. ã‚¢ã‚¯ã‚»ã‚¹æ¨©ãªã—ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ãªã—ï¼‰
            if (!myToken) {
                return AccessState.NO_ACCESS;
            }
            
            // 5. ã‚»ãƒƒã‚·ãƒ§ãƒ³æœŸé™åˆ‡ã‚Œï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ä¸ä¸€è‡´ï¼‰
            if (myToken !== serverToken) {
                return AccessState.EXPIRED;
            }
            
            // 6. çµ‚äº†çŠ¶æ…‹
            if (data.status === 'end') {
                return AccessState.ENDED;
            }
            
            // 7. ã‚¢ã‚¯ãƒ†ã‚£ãƒ–
            return AccessState.ACTIVE;
        }
    };

    // ==========================================================
    // UTILITY FUNCTIONS
    // ==========================================================
    const Utils = {
        generateSessionId: () => Math.random().toString(36).substring(2, 12),
        getNowStr: () => {
            const now = new Date();
            return `${now.getHours()}:${String(now.getMinutes()).padStart(2, '0')}`;
        },
        truncate: (str, len) => str.length > len ? str.substring(0, len) + '...' : str
    };

    // ==========================================================
    // MAIN APPLICATION
    // ==========================================================
    const App = {
        db: null,
        auth: null,
        cardCache: {},
        selectedCardId: null,
        patientId: null,
        lastKnownStatus: null,
        currentAccessState: null,
        isOnline: true,
        
        // --- INITIALIZATION ---
        init() {
            try {
                const app = initializeApp(firebaseConfig);
                this.db = getFirestore(app);
                this.auth = getAuth(app);
                
                // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³/ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç›£è¦–
                this.setupConnectivityMonitor();
                
                // Firebase ãƒªã‚¹ãƒŠãƒ¼
                this.setupFirebaseListener();
                
                // ãƒ¢ãƒ¼ãƒ‰åˆ¤å®š
                const myId = new URLSearchParams(window.location.search).get('id');
                if (myId) {
                    this.initPatientMode(myId);
                } else {
                    this.initStaffMode();
                }
            } catch (e) {
                console.error("Init Error:", e);
                this.showOfflineState();
            }
        },
        
        setupConnectivityMonitor() {
            window.addEventListener('online', () => this.setOnlineState(true));
            window.addEventListener('offline', () => this.setOnlineState(false));
        },
        
        setOnlineState(online) {
            this.isOnline = online;
            document.body.classList.toggle('is-offline', !online);
            const dot = document.querySelector('.conn-dot');
            if (dot) {
                dot.classList.toggle('online', online);
                dot.classList.toggle('offline', !online);
            }
        },
        
        showOfflineState() {
            this.setOnlineState(false);
        },
        
        setupFirebaseListener() {
            onSnapshot(collection(this.db, 'cards'), (snapshot) => {
                this.setOnlineState(true);
                document.getElementById('sys-status').innerHTML = 
                    '<span class="conn-dot online"></span>Connected (Tokyo)';
                
                // å·®åˆ†æ›´æ–°ã®ã¿å‡¦ç†
                snapshot.docChanges().forEach((change) => {
                    const id = change.doc.id;
                    const oldData = this.cardCache[id];
                    const newData = change.doc.data();
                    this.cardCache[id] = newData;
                    
                    // [DIFF RENDER] å¤‰æ›´ãŒã‚ã£ãŸã‚«ãƒ¼ãƒ‰ã®ã¿æ›´æ–°
                    if (document.body.classList.contains('mode-staff')) {
                        this.updateSingleCard(id, newData);
                        if (id == this.selectedCardId) {
                            this.renderPreview(id);
                        }
                    }
                });
                
                // æ‚£è€…ãƒ¢ãƒ¼ãƒ‰
                if (document.body.classList.contains('mode-patient') && this.patientId) {
                    this.syncPatientView(this.patientId);
                }
            }, (error) => {
                console.error("Firebase Error:", error);
                this.showOfflineState();
            });
        },
        
        // ===========================================
        // STAFF MODE
        // ===========================================
        initStaffMode() {
            document.body.classList.add('mode-staff');
            
            // åˆæœŸã‚°ãƒªãƒƒãƒ‰ç”Ÿæˆï¼ˆ1å›ã®ã¿ï¼‰
            this.buildStaffGrid();
            
            onAuthStateChanged(this.auth, (user) => {
                if (user) {
                    document.getElementById('auth-display').innerText = `User: ${user.email}`;
                } else {
                    this.performStaffLogin();
                }
            });
        },
        
        performStaffLogin() {
            const email = prompt("ã€è·å“¡èªè¨¼ã€‘ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹:", "");
            const password = prompt("ã€è·å“¡èªè¨¼ã€‘ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:", "");
            if (email && password) {
                signInWithEmailAndPassword(this.auth, email, password)
                    .catch((e) => { alert("èªè¨¼å¤±æ•—: " + e.message); location.reload(); });
            }
        },
        
        // [NEW] åˆæœŸã‚°ãƒªãƒƒãƒ‰æ§‹ç¯‰ï¼ˆDOMç”Ÿæˆã¯1å›ã®ã¿ï¼‰
        buildStaffGrid() {
            const grid = document.getElementById('s-grid');
            grid.innerHTML = '';
            
            for (let i = 1; i <= TOTAL_CARDS; i++) {
                const btn = document.createElement('div');
                btn.className = 's-card';
                btn.dataset.cardId = i;
                btn.innerText = i;
                
                btn.onclick = () => this.selectStaffCard(i);
                btn.oncontextmenu = (e) => { e.preventDefault(); this.handleStaffRightClick(i); };
                
                // é•·æŠ¼ã—å¯¾å¿œ
                let pressTimer;
                btn.ontouchstart = () => { pressTimer = setTimeout(() => this.handleStaffRightClick(i), 800); };
                btn.ontouchend = () => { clearTimeout(pressTimer); };
                
                grid.appendChild(btn);
            }
        },
        
        // [NEW] å·®åˆ†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° - å˜ä¸€ã‚«ãƒ¼ãƒ‰æ›´æ–°
        updateSingleCard(id, data) {
            const card = document.querySelector(`[data-card-id="${id}"]`);
            if (!card) return;
            
            // ã‚¯ãƒ©ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
            card.className = 's-card';
            card.dataset.cardId = id;
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é©ç”¨
            if (data && data.status) {
                card.classList.add('st-' + data.status);
            }
            
            // é¸æŠçŠ¶æ…‹
            if (id == this.selectedCardId) {
                card.classList.add('active');
            }
        },
        
        selectStaffCard(id) {
            const prevId = this.selectedCardId;
            this.selectedCardId = id;
            
            document.getElementById('s-target-num').innerText = id;
            document.getElementById('custom-msg-input').value = '';
            
            const controls = document.getElementById('s-controls');
            controls.style.opacity = 1;
            controls.style.pointerEvents = 'auto';
            
            // å·®åˆ†æ›´æ–°ï¼šå‰ã®é¸æŠã¨æ–°ã—ã„é¸æŠã®ã¿
            if (prevId) this.updateSingleCard(prevId, this.cardCache[prevId]);
            this.updateSingleCard(id, this.cardCache[id]);
            
            this.renderPreview(id);
        },
        
        async handleStaffRightClick(id) {
            if (!confirm(`No.${id} ã‚’çµ‚äº†ãƒ»åˆ‡æ–­ã—ã¾ã™ã‹ï¼Ÿ`)) return;
            await this.performUpdate(id, 'end', null);
        },
        
        renderPreview(id) {
            const data = this.cardCache[id];
            const screen = document.getElementById('prev-screen');
            screen.className = 'preview-body';
            
            if (!data || !data.status) {
                screen.innerHTML = `
                    <span class="prev-icon">ğŸ“·</span>
                    <div class="prev-title">æœªæ¥ç¶š</div>
                    <div class="prev-msg">QRèª­å–å¾…æ©Ÿä¸­</div>
                    <div class="prev-time">æ›´æ–°: --:--</div>
                `;
                return;
            }
            
            if (data.status === 'end') {
                screen.classList.add('mode-end');
                screen.innerHTML = `
                    <span class="prev-icon">ğŸ”š</span>
                    <div class="prev-title">çµ‚äº†</div>
                    <div class="prev-msg">å—ä»˜çµ‚äº†ã—ã¾ã—ãŸ</div>
                    <div class="prev-time">æ›´æ–°: ${data.time}</div>
                `;
                return;
            }

            let icon = '', title = '', desc = '';
            
            if (data.status === 'custom') {
                screen.classList.add('mode-custom');
                icon = STATUS_MAP['custom'].icon;
                title = STATUS_MAP['custom'].title;
                desc = data.message || '(ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã—)';
            } else {
                const info = STATUS_MAP[data.status] || STATUS_MAP['initial'];
                if (info.alert) screen.classList.add('mode-alert');
                if (data.status === 'ward') screen.classList.add('mode-ward');
                icon = info.icon;
                title = info.title;
                desc = info.desc;
            }
            
            desc = Utils.truncate(desc, 20);
            
            screen.innerHTML = `
                <span class="prev-icon">${icon}</span>
                <div class="prev-title">${title}</div>
                <div class="prev-msg">${desc}</div>
                <div class="prev-time">æ›´æ–°: ${data.time}</div>
            `;
        },
        
        // --- STAFF WRITER ---
        updateStatus(statusKey) {
            if (this.selectedCardId) {
                this.performUpdate(this.selectedCardId, statusKey, null);
            }
        },
        
        sendCustomMessage() {
            if (!this.selectedCardId) return;
            const text = document.getElementById('custom-msg-input').value.trim();
            if (!text) return alert("ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            this.performUpdate(this.selectedCardId, 'custom', text);
        },
        
        async performUpdate(id, statusKey, customText) {
            if (!this.db) return;
            
            const currentData = this.cardCache[id] || {};
            let currentSess = currentData.sessionId;
            
            // çµ‚äº†ãƒ»ãƒªã‚»ãƒƒãƒˆæ™‚ã¯æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ID
            if (!currentSess || statusKey === 'end' || statusKey === 'initial') {
                currentSess = Utils.generateSessionId();
            }

            const payload = {
                status: statusKey,
                time: Utils.getNowStr(),
                message: customText,
                sessionId: currentSess
            };
            
            try {
                await setDoc(doc(this.db, "cards", String(id)), payload, { merge: true });
            } catch(e) {
                console.error(e);
                alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼: ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„");
            }
        },
        
        // ===========================================
        // PATIENT MODE
        // ===========================================
        initPatientMode(id) {
            document.body.classList.add('mode-patient');
            this.patientId = id;
            document.getElementById('p-num').innerText = id;
            
            // éŸ³å£°æœ‰åŠ¹åŒ–ãƒœã‚¿ãƒ³è¡¨ç¤º
            setTimeout(() => {
                if (!AudioSystem.unlocked) {
                    document.getElementById('sound-enable-overlay').style.display = 'block';
                }
            }, 1000);
            
            this.syncPatientView(id);
        },
        
        // [NEW] çµ±ä¸€ã•ã‚ŒãŸPatient ViewåŒæœŸ
        syncPatientView(id) {
            const data = this.cardCache[id];
            const container = document.getElementById('patient-app');
            const contentArea = document.getElementById('p-content-area');
            
            // ãƒªã‚»ãƒƒãƒˆ
            container.className = '';
            document.getElementById('p-view-body').className = 'p-body';
            
            // [CORE] ã‚¢ã‚¯ã‚»ã‚¹çŠ¶æ…‹ã‚’åˆ¤å®š
            const accessState = SessionManager.getAccessState(id, data);
            
            // çŠ¶æ…‹é·ç§»ã®æ¤œè¨¼
            if (this.currentAccessState && !StateMachine.validate(this.currentAccessState, accessState)) {
                console.warn(`Unexpected state transition, forcing to: ${accessState}`);
            }
            this.currentAccessState = accessState;
            
            // [SOUND] ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´æ™‚ã«é€šçŸ¥éŸ³
            if (data && this.lastKnownStatus && 
                this.lastKnownStatus !== data.status && 
                data.status !== 'end' &&
                accessState === AccessState.ACTIVE) {
                AudioSystem.playNotification();
            }
            this.lastKnownStatus = data?.status;
            
            // çŠ¶æ…‹ã«å¿œã˜ãŸãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            switch (accessState) {
                case AccessState.NOT_REGISTERED:
                    this.renderPatientScreen(contentArea, container, {
                        icon: 'ğŸ¤”', title: 'æœªç™»éŒ²',
                        msg: 'è·å“¡ã®æ“ä½œã‚’ãŠå¾…ã¡ãã ã•ã„'
                    });
                    break;
                    
                case AccessState.CAN_JOIN:
                    this.renderJoinScreen(contentArea, id, data.sessionId);
                    break;
                    
                case AccessState.ACTIVE:
                    this.renderActiveScreen(contentArea, container, data);
                    break;
                    
                case AccessState.EXPIRED:
                    // ãƒ–ãƒ­ãƒƒã‚¯ç™»éŒ² & ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒªã‚¢
                    SessionManager.clear(id);
                    BlockManager.setBlock(id, data.sessionId);
                    this.renderEndScreen(contentArea, container, data.time, 
                        'æ–°ã—ã„è¨ºå¯ŸãŒé–‹å§‹ã•ã‚ŒãŸãŸã‚åˆ‡æ–­ã•ã‚Œã¾ã—ãŸ', true);
                    break;
                    
                case AccessState.ENDED:
                    SessionManager.clear(id);
                    BlockManager.setBlock(id, data.sessionId);
                    this.renderEndScreen(contentArea, container, data.time,
                        'æœ¬æ—¥ã®å—ä»˜é€šçŸ¥ã¯çµ‚äº†ã—ã¾ã—ãŸ', true);
                    break;
                    
                case AccessState.BLOCKED:
                    this.renderEndScreen(contentArea, container, data?.time,
                        'ã“ã®ç•ªå·ã®æ¡ˆå†…ã¯çµ‚äº†ã—ã¾ã—ãŸã€‚<br>æ–°ã—ã„ç•ªå·ã‚’ãŠæŒã¡ã®æ–¹ã¯ã€<br>QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã£ã¦ãã ã•ã„ã€‚', true);
                    break;
                    
                case AccessState.NO_ACCESS:
                    this.renderPatientScreen(contentArea, container, {
                        icon: 'ğŸ”’', title: 'åˆ©ç”¨ä¸å¯',
                        msg: 'åˆ¥ã®ç«¯æœ«ã§ä½¿ç”¨ä¸­ã‹ã€<br>å—ä»˜ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸã€‚'
                    });
                    break;
            }
        },
        
        renderPatientScreen(el, container, { icon, title, msg, time }) {
            el.innerHTML = `
                <span class="p-icon">${icon}</span>
                <div class="p-title">${title}</div>
                <div class="p-info-box">
                    <div class="p-msg">${msg}</div>
                    ${time ? `<div class="p-time">æ›´æ–°: ${time}</div>` : ''}
                </div>
            `;
        },
        
        renderJoinScreen(el, id, sessionId) {
            el.innerHTML = `
                <span class="p-icon">ğŸ“²</span>
                <div class="p-title">æ¥ç¶šç¢ºèª</div>
                <div class="p-msg" style="background:none;">
                    è¨ºå¯Ÿåˆ¸ç•ªå· ${id}ç•ª ã§<br>å—ä»˜çŠ¶æ³ã‚’ç¢ºèªã—ã¾ã™ã‹ï¼Ÿ
                </div>
                <button class="btn-connect" onclick="App.manualJoin(${id}, '${sessionId}')">
                    æ¥ç¶šã™ã‚‹
                </button>
            `;
        },
        
        renderActiveScreen(el, container, data) {
            let icon = '', title = '', desc = '';
            
            if (data.status === 'custom') {
                container.classList.add('mode-custom');
                icon = STATUS_MAP['custom'].icon;
                title = STATUS_MAP['custom'].title;
                desc = data.message || '(ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã—)';
            } else if (data.status === 'initial') {
                // æ¥ç¶šç›´å¾Œã®åˆæœŸçŠ¶æ…‹
                icon = 'ğŸ¥';
                title = 'å—ä»˜å®Œäº†';
                desc = 'é †ç•ªã«ãƒˆãƒªã‚¢ãƒ¼ã‚¸ãƒ»è¨ºå¯Ÿã®æº–å‚™ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚ãã®ã¾ã¾ãŠå¾…ã¡ãã ã•ã„ã€‚';
            } else {
                const info = STATUS_MAP[data.status] || STATUS_MAP['initial'];
                if (info.alert) container.classList.add('mode-alert');
                if (data.status === 'ward') container.classList.add('mode-ward');
                icon = info.icon;
                title = info.title;
                desc = info.desc;
            }
            
            el.innerHTML = `
                <span class="p-icon">${icon}</span>
                <div class="p-title">${title}</div>
                <div class="p-info-box">
                    <div class="p-msg">${desc}</div>
                    <div class="p-time">æ›´æ–°: ${data.time}</div>
                </div>
            `;
        },
        
        renderEndScreen(el, container, time, message, showUnblock = false) {
            container.classList.add('mode-end');
            
            const unblockHtml = showUnblock ? `
                <div class="clear-block-link" onclick="App.requestUnblock(${this.patientId})">
                    å†æ¥é™¢ã®æ–¹: æ–°ã—ã„è¨ºå¯Ÿã§åˆ©ç”¨ã™ã‚‹å ´åˆã¯ã“ã¡ã‚‰
                </div>
            ` : '';
            
            el.innerHTML = `
                <span class="p-icon">ğŸ”š</span>
                <div class="p-title">çµ‚äº†</div>
                <div class="p-info-box">
                    <div class="p-msg" style="font-weight:bold;">${message}</div>
                    <div class="p-time">æœ€çµ‚æ›´æ–°: ${time || '--:--'}</div>
                </div>
                ${unblockHtml}
            `;
        },
        
        manualJoin(id, sessionId) {
            SessionManager.set(id, sessionId);
            BlockManager.clearBlock(id); // ãƒ–ãƒ­ãƒƒã‚¯è§£é™¤
            this.syncPatientView(id);
        },
        
        // [SECURITY] ãƒ–ãƒ­ãƒƒã‚¯è§£é™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼ˆç¢ºèªä»˜ãï¼‰
        requestUnblock(id) {
            const confirmed = confirm(
                'æ–°ã—ã„è¨ºå¯Ÿã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ\n\n' +
                'â€»åŒã˜ç•ªå·ã§åˆ¥ã®æ‚£è€…æ§˜ãŒä½¿ç”¨ä¸­ã®å ´åˆã€\n' +
                'ã€€æ­£ã—ãè¡¨ç¤ºã•ã‚Œãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚'
            );
            if (confirmed) {
                BlockManager.clearBlock(id);
                SessionManager.clear(id);
                location.reload();
            }
        },
        
        unlockAudio() {
            AudioSystem.unlock();
        }
    };

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å…¬é–‹ï¼ˆonclickç”¨ï¼‰
    window.App = App;
    
    // èµ·å‹•
    window.addEventListener('DOMContentLoaded', () => App.init());

</script>
</body>
</html>
